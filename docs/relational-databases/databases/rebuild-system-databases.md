---
description: Перестроение системных баз данных
title: Перестроение системных баз данных | Документация Майкрософт
ms.custom: ''
ms.date: 06/06/2016
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- master database [SQL Server], rebuilding
- REBUILDDATABASE parameter
- rebuilding databases, master
- system databases [SQL Server], rebuilding
ms.assetid: af457ecd-523e-4809-9652-bdf2e81bd876
author: stevestein
ms.author: sstein
ms.openlocfilehash: 2365440fd87789a30e67c8c5effcbf0e85b8bc24
ms.sourcegitcommit: 544706f6725ec6cdca59da3a0ead12b99accb2cc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2020
ms.locfileid: "92638997"
---
# <a name="rebuild-system-databases"></a>Перестроение системных баз данных
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
  Системные базы данных необходимо перестроить, чтобы устранить повреждения данных в системных базах данных [master](../../relational-databases/databases/master-database.md), [model](../../relational-databases/databases/model-database.md), [msdb](../../relational-databases/databases/msdb-database.md)и [resource](../../relational-databases/databases/resource-database.md) или изменить параметры сортировки по умолчанию на уровне сервера. В этом разделе приводятся пошаговые инструкции по перестроению системных баз данных в [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].  
  
 **В этом разделе**  
  
   - **Перед началом работы**  
  
     [Ограничения](#Restrictions)  
  
     [Предварительные требования](#Prerequisites)  
  
   - **Процедуры**  
  
     [Перестроение системных баз данных](#RebuildProcedure)  
  
     [Перестроение базы данных Resource](#Resource)  
  
     [Создание новой базы данных msdb](#CreateMSDB) 

     [Перестроение базы данных tempdb](#RebuildTempdb)  
  
   - **Дальнейшие действия.**  
  
     [Устранение ошибок перестроения](#Troubleshoot)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> Ограничения  
 При перестроении системных баз данных master, model, msdb и tempdb эти базы данных удаляются и создаются повторно в исходном расположении. Если в инструкции перестроения заданы новые параметры сортировки, системные базы данных создаются с этими параметрами. Все пользовательские изменения этих баз данных будут потеряны. Например, в базе данных master могут содержаться пользовательские объекты, в базе данных msdb — запланированные задания, а в базе данных model — изменения исходных параметров баз данных.  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> Предварительные требования  
 Перед перестроением системных баз данных выполните следующие задачи, чтобы иметь возможность восстановить текущие параметры системных баз данных.  
  
1. Зарегистрируйте все значения конфигурации на уровне сервера.  
  
    ```SQL  
    SELECT * FROM sys.configurations;  
    ```  
  
2.  Зарегистрируйте все исправления, примененные к экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], и текущие параметры сортировки. Эти исправления необходимо применить после перестроения системных баз данных.  
  
    ```SQL  
    SELECT  
    SERVERPROPERTY('ProductVersion ') AS ProductVersion,  
    SERVERPROPERTY('ProductLevel') AS ProductLevel,  
    SERVERPROPERTY('ResourceVersion') AS ResourceVersion,  
    SERVERPROPERTY('ResourceLastUpdateDateTime') AS ResourceLastUpdateDateTime,  
    SERVERPROPERTY('Collation') AS Collation;  
    ```  
  
3.  Зарегистрируйте текущее расположение всех файлов данных и журналов для системных баз данных. При перестроении системных баз данных они устанавливаются в исходное расположение. Если системные файлы данных и журналов были перемещены в другие расположения, необходимо вернуть их в исходное место.  
  
    ```SQL  
    SELECT name, physical_name AS current_file_location  
    FROM sys.master_files  
    WHERE database_id IN (DB_ID('master'), DB_ID('model'), DB_ID('msdb'), DB_ID('tempdb'));  
    ```  
  
4.  Найдите текущую резервную копию баз данных master, model и msdb.  
  
5.  Если экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] настроен как распространитель репликации, найдите текущую резервную копию базы данных распространителя.  
  
6.  Убедитесь, что имеются соответствующие разрешения для перестроения системных баз данных. Чтобы выполнить эту операцию, необходимо быть членом предопределенной роли сервера **sysadmin** . Дополнительные сведения см. в статье [Роли уровня сервера](../../relational-databases/security/authentication-access/server-level-roles.md).  
  
7.  Проверьте, имеются ли на локальном сервере копии шаблонов для файлов данных и файлов журналов баз данных master, model и msdb. По умолчанию файлы шаблонов расположены в каталоге C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Binn\Templates. Эти файлы используются во время перестроения и должны присутствовать для успешного завершения программы установки. Если они отсутствуют, используйте функцию исправления программы установки или вручную скопируйте их с установочного носителя. Чтобы найти эти файлы на установочном носителе, перейдите в каталог, соответствующий платформе (x86 или x64), а затем в папку setup\sql_engine_core_inst_msi\Pfiles\SqlServr\MSSQL.X\MSSQL\Binn\Templates.  
  
##  <a name="rebuild-system-databases"></a><a name="RebuildProcedure"></a> Перестроение системных баз данных  
 Следующая процедура перестраивает системные базы данных master, model, msdb и tempdb. Нельзя выбрать, какие системные базы данных будут перестраиваться. Для кластеризованных экземпляров эту процедуру необходимо выполнить на активном узле, а ресурс [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в соответствующей группе приложений кластера перед ее выполнением должен быть переведен в состояние «вне сети».  
  
 Эта процедура не перестраивает базу данных resource. См. раздел «Процедура перестроения базы данных resource» ниже.  
  
#### <a name="to-rebuild-system-databases-for-an-instance-of-sql-server"></a>Перестроение системных баз данных для экземпляра SQL Server:  
  
1.  Вставьте в дисковод установочный носитель [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] или введите в командной строке путь к файлу setup.exe на локальном сервере. По умолчанию он расположен на сервере в каталоге C:\Program Files\Microsoft SQL Server\130\Setup Bootstrap\SQLServer2016.  
  
2.  В командной строке введите следующую команду. Квадратные скобки указывают, что параметр необязателен. Квадратные скобки не вводятся. В операционной системе Windows с включенным контролем учетных записей (UAC) запуск программы установки требует повышенных прав доступа. Команда в командной строке должна выполняться от имени администратора.  
  
     **Setup /QUIET /ACTION=REBUILDDATABASE /INSTANCENAME=ИмяЭкземпляра /SQLSYSADMINACCOUNTS=учетные записи [ /SAPWD= НадежныйПароль ] [ /SQLCOLLATION=ИмяПараметровСортировки]**  
  
    |Имя параметра|Описание|  
    |--------------------|-----------------|  
    |/QUIET или /Q|Указывает, что программа установки будет работать без пользовательского интерфейса.|  
    |/ACTION=REBUILDDATABASE|Указывает, что программа установки создает системные базы данных заново.|  
    |/INSTANCENAME= *имя_экземпляра*|Имя экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Для экземпляра по умолчанию введите MSSQLSERVER.|  
    |/SQLSYSADMINACCOUNTS= *учетные_записи*|Задает учетные записи групп Windows или индивидуальные учетные записи, которые следует добавить к предопределенной роли сервера **sysadmin** . При указании нескольких учетных записей их нужно разделять пробелами. Например, введите **BUILTIN\Administrators MyDomain\MyUser** . Если учетная запись содержит в своем имени пробелы, заключайте ее имя в двойные кавычки. Например, введите **"NT AUTHORITY\SYSTEM"** .|  
    |[ /SAPWD= *надежный_пароль* ]|Задает пароль для учетной записи [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] **sa** . Этот параметр обязателен, если экземпляр использует смешанный режим проверки подлинности (проверка подлинности[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и Windows).<br /><br /> **&#42;&#42; Примечание по безопасности &#42;&#42;** Учетная запись **sa**  — хорошо известная учетная запись [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], поэтому она часто становится мишенью злоумышленников. Для имени входа **sa** очень важно использовать надежный пароль.<br /><br /> Для режима проверки подлинности Windows этот параметр не указывается.|  
    |[/SQLCOLLATION= *имя_параметров_сортировки* ]|Указывает новые параметры сортировки на уровне сервера. Это необязательный параметр. При его отсутствии используются текущие параметры сортировки сервера.<br /><br /> **\*\* Важно! \*\*** Изменение параметров сортировки на уровне сервера не меняет параметры сортировки существующих баз данных. Вновь созданный пользователь по умолчанию будет использовать новые параметры сортировки.<br /><br /> Дополнительные сведения см. в разделе [Задание или изменение параметров сортировки сервера](../../relational-databases/collations/set-or-change-the-server-collation.md).|  
    |[ /SQLTEMPDBFILECOUNT=NumberOfFiles ]|Указывает количество файлов данных в базе данных tempdb. Можно указать максимум 8 или количество ядер (большее из этих значений).<br /><br /> Значение по умолчанию: 8 или количество ядер (меньшее из этих значений) для всех остальных выпусков.|  
    |[ /SQLTEMPDBFILESIZE=FileSizeInMB ]|Задает первоначальный размер файла данных для каждой базы данных tempdb. Программа установки поддерживает размер до 1024 МБ.<br /><br /> Значение по умолчанию: 8|  
    |[ /SQLTEMPDBFILEGROWTH=FileSizeInMB ]|Определяет шаг увеличения размера для файла данных tempdb (в МБ). Значение 0 указывает, что автоматическое приращение отключено и добавление пространства запрещено. Программа установки поддерживает размер до 1024 МБ.<br /><br /> Значение по умолчанию: 64|  
    |[ /SQLTEMPDBLOGFILESIZE=FileSizeInMB ]|Задает первоначальный размер файла журнала tempdb (в МБ). Программа установки поддерживает размер до 1024 МБ.<br /><br /> Значение по умолчанию: 8.<br /><br /> Допустимый диапазон: минимум 8, максимум 1024.|  
    |[ /SQLTEMPDBLOGFILEGROWTH=FileSizeInMB ]|Определяет шаг увеличения размера для файла журнала tempdb (в МБ). Значение 0 указывает, что автоматическое приращение отключено и добавление пространства запрещено. Программа установки поддерживает размер до 1024 МБ.<br /><br /> Значение по умолчанию: 64<br /><br /> Допустимый диапазон: минимум 8, максимум 1024.|  
    |[ /SQLTEMPDBDIR=Directories ]|Указывает каталог для файлов данных tempdb. При указании нескольких каталогов их нужно разделять пробелами. Если указано несколько каталогов, файлы данных tempdb будут распределяться по каталогам по методу циклического перебора.<br /><br /> Значение по умолчанию: системный каталог данных|  
    |[ /SQLTEMPDBLOGDIR=Directory ]|Указывает каталог для файла журнала tempdb.<br /><br /> Значение по умолчанию: системный каталог данных|  
  
3.  Когда программа установки завершает перестроение системных баз данных, она возвращается в командную строку без сообщений. Просмотрите файл журнала Summary.txt, чтобы убедиться, что процесс завершился успешно. Этот файл расположен в папке C:\Program Files\Microsoft SQL Server\130\Setup Bootstrap\Logs.  
  
4.  Сценарий RebuildDatabase удаляет системные базы данных и устанавливает их в исходном состоянии. Так как счетчик числа файлов tempdb не сохраняется, во время установки значение числа файлов tempdb неизвестно. Поэтому сценарий RebuildDatabase не имеет сведений о количестве файлов tempdb, которое необходимо добавить заново. Введите значение числа файлов tempdb с помощью параметра SQLTEMPDBFILECOUNT. Если этот параметр не указан, сценарий RebuildDatabase добавит число файлов tempdb по умолчанию, равное количеству ЦП или 8 (в зависимости от того, какое значение меньше).  
  
## <a name="post-rebuild-tasks"></a>Задачи, выполняемые после перестроения  
 После перестроения базы данных, возможно, придется выполнить следующие дополнительные задачи.  
  
-   Восстановить наиболее поздние полные резервные копии баз данных master, model и msdb. Дополнительные сведения см. в статье [Резервное копирование и восстановление системных баз данных (SQL Server)](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).  
  
    > [!IMPORTANT]  
    >  Если изменены параметры сортировки сервера, не следует восстанавливать системные базы данных. В противном случае новые параметры сортировки будут заменены старыми.  
  
     Если резервная копия недоступна или не является копией текущей базы данных, повторно создайте все отсутствующие записи. Например, повторно создайте все недостающие записи для пользовательских баз данных, устройств резервного копирования, имен входа [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , конечных точек и так далее. Лучшим способом повторного создания записей является запуск создавшего их исходного скрипта.  
  
> [!IMPORTANT]  
>  Рекомендуется защитить применяемые скрипты, чтобы предотвратить их изменение неавторизированными пользователями.  
  
-   Если экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] настроен как распространитель репликации, необходимо восстановить базу данных distribution. Дополнительные сведения см. в разделе [Резервное копирование и восстановление реплицируемых баз данных](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).  
  
-   Переместить системные базы данных в зарегистрированное ранее расположение. Дополнительные сведения см. в статье [Перемещение системных баз данных](../../relational-databases/databases/move-system-databases.md).  
  
-   Проверить, соответствуют ли значения конфигурации на уровне сервера зарегистрированным ранее значениям.  
  
##  <a name="rebuild-the-resource-database"></a><a name="Resource"></a> Перестроение базы данных Resource  
 Приведенная ниже процедура перестраивает системную базу данных resource. После перестроения базы данных resource все исправления теряются, поэтому их следует применить заново.  
  
#### <a name="to-rebuild-the-resource-system-database"></a>Перестроение базы данных resource  
  
1.  Запустите программу установки [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] (setup.exe), расположенную на установочном носителе.  
  
2.  В левой части области переходов нажмите кнопку **Обслуживание** и выберите **Исправить** .  
  
3.  Будут запущены правило поддержки установки и файлы подпрограмм для того, чтобы удостовериться, что в системе установлены необходимые компоненты и компьютер отвечает правилам проверки. Для продолжения нажмите кнопку **ОК** или **Установить** .  
  
4.  На странице «Выбор экземпляра» выберите экземпляр для исправления и нажмите кнопку **Далее** .  
  
5.  Будут запущены правила исправления для проверки операции. Чтобы продолжить, нажмите кнопку **Далее** .  
  
6.  На странице **Все готово для восстановления** нажмите кнопку **Исправить** . Страница «Готово» показывает, что операция завершена.  
  
##  <a name="create-a-new-msdb-database"></a><a name="CreateMSDB"></a> Создание новой базы данных msdb  

 Если база данных **msdb** повреждена и нет резервной копии базы данных **msdb** , можно создать новую базу данных **msdb** с помощью скрипта **instmsdb** .  
  
> [!WARNING]  
>  Когда база данных **msdb** создается заново скриптом **instmsdb** , удаляется вся информация, которая хранилась в **msdb** , то есть задания, оповещения, операторы, планы обслуживания, журналы резервных копий, параметры системы управления на основе политик, компоненты Database Mail, хранилище данных о производительности и т. д.  
  
1.  Остановите все службы, подключающиеся к компоненту [!INCLUDE[ssDE](../../includes/ssde-md.md)], включая агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , службы [!INCLUDE[ssRS](../../includes/ssrs.md)], службы [!INCLUDE[ssIS](../../includes/ssis-md.md)]и все приложения, использующие [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] как хранилище данных.  
  
2.  Запустите [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] из командной строки с помощью команды: `NET START MSSQLSERVER /T3608`  
  
     Дополнительные сведения см. в статье [Iniciar, parar, pausar, retomar e reiniciar os serviços SQL Server](../../database-engine/configure-windows/start-stop-pause-resume-restart-sql-server-services.md).  
  
3.  В другом окне командной строки отключите базу данных **msdb** , выполнив следующую команду, которая заменяет *\<servername>* экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]: `SQLCMD -E -S<servername> -dmaster -Q"EXEC sp_detach_db msdb"`  
  
4.  С помощью проводника Windows переименуйте файлы базы данных **msdb** . По умолчанию они находятся в папке DATA соответствующего экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .  
  
5.  С помощью диспетчера конфигурации [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] остановите и перезапустите службу компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)] , как обычно.  
  
6.  В окне командной строки подключитесь к серверу [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и выполните следующую команду: `SQLCMD -E -S<servername> -i"C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Install\instmsdb.sql" -o"C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Install\instmsdb.out"`  
  
     Замените *\<servername>* на экземпляр компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)]. Укажите путь к экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]в файловой системе.  
  
7.  Откройте в Блокноте файл **instmsdb.out** и проверьте выходные данные на наличие ошибок.  
  
8.  Примените заново все исправления, которые были установлены на экземпляре.  
  
9. Создайте заново пользовательское содержимое базы данных **msdb** , в том числе задания, оповещения и т. д.  
  
10. Создайте резервную копию базы данных **msdb** .  

##  <a name="rebuild-the-tempdb-database"></a><a name="RebuildTempdb"></a> Перестроение базы данных tempdb  

Если база данных **tempdb** повреждена и ядро СУБД не запускается, вы можете перестроить **tempdb** без необходимости перестраивать все системные базы.
  
1. Переименуйте текущие файлы tempdb.mdf и templog.ldf, если они не отсутствуют. 
1. Запустите [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] из командной строки, выполнив следующую команду. 

   ```sql
   sqlservr -c -f -T3608 -T4022 -s <instance> -mSQLCMD
   ```

   В качестве имени экземпляра по умолчанию используйте MSSQLSERVER, а именованного экземпляра — MSSQL$<имя_экземпляра>. Флаг трассировки 4022 отключает выполнение хранимых процедур запуска. Параметр -mSQLCMD позволяет только [sqlcmd.exe](../../ssms/scripting/sqlcmd-use-the-utility.md) подключаться к серверу (см. [Дополнительные параметры запуска](../../database-engine/configure-windows/database-engine-service-startup-options.md#other-startup-options)).

   > [!Note] 
   > Сохраняйте окно командной строки открытым после запуска [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. В случае закрытия окна командной строки процесс будет завершен.

1. Подключитесь к серверу с помощью **sqlcmd** , а затем сбросьте состояние базы данных tempdb, используя следующую хранимую процедуру.

   ```sql
   exec master..sp_resetstatus tempdb
   ```

1. Завершите работу сервера, нажав в окне командной строки клавиши CTRL+C.

1. Перезапустите службу [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Это создаст новый набор файлов базы данных tempdb и восстановит эту базу.

  
##  <a name="troubleshoot-rebuild-errors"></a><a name="Troubleshoot"></a> Устранение ошибок перестроения  
 Ошибки синтаксиса и ошибки времени выполнения отображаются в окне командной строки. Проверьте инструкцию установки на наличие следующих синтаксических ошибок:  
  
-   отсутствие символа косой черты (/) перед именем параметра;  
  
-   отсутствие знака равенства (=) между именем и значением параметра;  
  
-   наличие пробелов между именем параметра и знаком равенства;  
  
-   наличие запятых (,) или других символов, не предусмотренных синтаксисом.  
  
 По завершении процедуры перестроения проверьте журналы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] на наличие ошибок. По умолчанию журналы расположены в папке C:\Program Files\Microsoft SQL Server\130\Setup Bootstrap\Logs. Чтобы найти файл журнала, который содержит результаты перестроения, в командной строке перейдите в папку журналов и запустите команду `findstr /s RebuildDatabase summary*.*`. Будут возвращены все файлы журналов, в которых содержатся результаты перестроения системных баз данных. Откройте эти файлы журналов и внимательно просмотрите, имеются ли в них соответствующие сообщения об ошибках.  
  
## <a name="see-also"></a>См. также:  
 [Системные базы данных](../../relational-databases/databases/system-databases.md)  
  
  
